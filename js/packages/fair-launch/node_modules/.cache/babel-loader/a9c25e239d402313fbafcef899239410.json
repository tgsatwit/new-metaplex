{"ast":null,"code":"import _toConsumableArray from\"/Users/timgillam/Documents/GitHub/metaplex_new/new-metaplex/js/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _regeneratorRuntime from\"/Users/timgillam/Documents/GitHub/metaplex_new/new-metaplex/js/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _slicedToArray from\"/Users/timgillam/Documents/GitHub/metaplex_new/new-metaplex/js/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _asyncToGenerator from\"/Users/timgillam/Documents/GitHub/metaplex_new/new-metaplex/js/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import*as anchor from'@project-serum/anchor';import{TOKEN_PROGRAM_ID,Token}from'@solana/spl-token';import{LAMPORTS_PER_SOL}from'@solana/web3.js';import{createAssociatedTokenAccountInstruction,getAtaForMint,getFairLaunchTicketSeqLookup}from'./utils';export var FAIR_LAUNCH_PROGRAM=new anchor.web3.PublicKey('faircnAB9k59Y4TXmLabBULeuTLgV7TkGMGNkjnA15j');export var LotteryState;(function(LotteryState){LotteryState[\"Brewing\"]=\"Brewing\";LotteryState[\"Finished\"]=\"Finished\";LotteryState[\"PastDue\"]=\"Past Due\";})(LotteryState||(LotteryState={}));export var getLotteryState=function getLotteryState(phaseThree,lottery,lotteryDuration,phaseTwoEnd){if(!phaseThree&&(!lottery||lottery.length===0)&&phaseTwoEnd.add(lotteryDuration).lt(new anchor.BN(Date.now()/1000))){return LotteryState.PastDue;}else if(phaseThree){return LotteryState.Finished;}else{return LotteryState.Brewing;}};export var getFairLaunchState=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(anchorWallet,fairLaunchId,connection){var provider,idl,program,state,_yield$getFairLaunchT,_yield$getFairLaunchT2,fairLaunchTicket,bump,fairLaunchData,treasury,lotteryData,fairLaunchLotteryBitmap,fairLaunchLotteryBitmapObj;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:provider=new anchor.Provider(connection,anchorWallet,{preflightCommitment:'recent'});_context.next=3;return anchor.Program.fetchIdl(FAIR_LAUNCH_PROGRAM,provider);case 3:idl=_context.sent;program=new anchor.Program(idl,FAIR_LAUNCH_PROGRAM,provider);_context.next=7;return program.account.fairLaunch.fetch(fairLaunchId);case 7:state=_context.sent;_context.next=10;return getFairLaunchTicket(//@ts-ignore\nstate.tokenMint,anchorWallet.publicKey);case 10:_yield$getFairLaunchT=_context.sent;_yield$getFairLaunchT2=_slicedToArray(_yield$getFairLaunchT,2);fairLaunchTicket=_yield$getFairLaunchT2[0];bump=_yield$getFairLaunchT2[1];_context.prev=14;_context.next=17;return program.account.fairLaunchTicket.fetch(fairLaunchTicket);case 17:fairLaunchData=_context.sent;_context.next=23;break;case 20:_context.prev=20;_context.t0=_context[\"catch\"](14);console.log('No ticket');case 23:_context.next=25;return program.provider.connection.getBalance(state.treasury);case 25:treasury=_context.sent;lotteryData=new Uint8Array([]);_context.next=29;return getFairLaunchLotteryBitmap(//@ts-ignore\nstate.tokenMint);case 29:fairLaunchLotteryBitmap=_context.sent[0];_context.prev=30;_context.next=33;return program.provider.connection.getAccountInfo(fairLaunchLotteryBitmap);case 33:fairLaunchLotteryBitmapObj=_context.sent;lotteryData=new Uint8Array((fairLaunchLotteryBitmapObj===null||fairLaunchLotteryBitmapObj===void 0?void 0:fairLaunchLotteryBitmapObj.data)||[]);_context.next=41;break;case 37:_context.prev=37;_context.t1=_context[\"catch\"](30);console.log('Could not find fair launch lottery.');console.log(_context.t1);case 41:return _context.abrupt(\"return\",{id:fairLaunchId,state:state,program:program,ticket:{pubkey:fairLaunchTicket,bump:bump,data:fairLaunchData},lottery:{pubkey:fairLaunchLotteryBitmap,data:lotteryData},treasury:treasury});case 42:case\"end\":return _context.stop();}}},_callee,null,[[14,20],[30,37]]);}));return function getFairLaunchState(_x,_x2,_x3){return _ref.apply(this,arguments);};}();export var punchTicket=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(anchorWallet,fairLaunch){var fairLaunchTicket,ticket,fairLaunchLotteryBitmap,buyerTokenAccount,_yield$getSetupForTic,remainingAccounts,_instructions,signers,accountExists,instructions;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return getFairLaunchTicket(//@ts-ignore\nfairLaunch.state.tokenMint,anchorWallet.publicKey);case 2:fairLaunchTicket=_context2.sent[0];ticket=fairLaunch.ticket.data;_context2.next=6;return getFairLaunchLotteryBitmap(fairLaunch.state.tokenMint);case 6:fairLaunchLotteryBitmap=_context2.sent[0];_context2.next=9;return getAtaForMint(//@ts-ignore\nfairLaunch.state.tokenMint,anchorWallet.publicKey);case 9:buyerTokenAccount=_context2.sent[0];if(!(ticket===null||ticket===void 0?void 0:ticket.amount.gt(fairLaunch.state.currentMedian))){_context2.next=20;break;}console.log('Adjusting down...',ticket===null||ticket===void 0?void 0:ticket.amount.toNumber(),fairLaunch.state.currentMedian.toNumber());_context2.next=14;return getSetupForTicketing(fairLaunch.program,fairLaunch.state.currentMedian.toNumber(),anchorWallet,fairLaunch,fairLaunchTicket);case 14:_yield$getSetupForTic=_context2.sent;remainingAccounts=_yield$getSetupForTic.remainingAccounts;_instructions=_yield$getSetupForTic.instructions;signers=_yield$getSetupForTic.signers;_context2.next=20;return fairLaunch.program.rpc.adjustTicket(fairLaunch.state.currentMedian,{accounts:{fairLaunchTicket:fairLaunchTicket,fairLaunch:fairLaunch.id,fairLaunchLotteryBitmap:fairLaunchLotteryBitmap,//@ts-ignore\ntreasury:fairLaunch.state.treasury,systemProgram:anchor.web3.SystemProgram.programId,clock:anchor.web3.SYSVAR_CLOCK_PUBKEY},__private:{logAccounts:true},instructions:_instructions.length>0?_instructions:undefined,remainingAccounts:[{pubkey:anchorWallet.publicKey,isSigner:true,isWritable:true}].concat(_toConsumableArray(remainingAccounts)),signers:signers});case 20:_context2.next=22;return fairLaunch.program.provider.connection.getAccountInfo(buyerTokenAccount);case 22:accountExists=_context2.sent;instructions=!accountExists?[createAssociatedTokenAccountInstruction(buyerTokenAccount,anchorWallet.publicKey,anchorWallet.publicKey,//@ts-ignore\nfairLaunch.state.tokenMint)]:[];_context2.next=26;return fairLaunch.program.rpc.punchTicket({accounts:{fairLaunchTicket:fairLaunchTicket,fairLaunch:fairLaunch.id,fairLaunchLotteryBitmap:fairLaunchLotteryBitmap,payer:anchorWallet.publicKey,buyerTokenAccount:buyerTokenAccount,//@ts-ignore\ntokenMint:fairLaunch.state.tokenMint,tokenProgram:TOKEN_PROGRAM_ID},instructions:instructions.length>0?instructions:undefined});case 26:case\"end\":return _context2.stop();}}},_callee2);}));return function punchTicket(_x4,_x5){return _ref2.apply(this,arguments);};}();export var getFairLaunchTicket=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(tokenMint,buyer){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return anchor.web3.PublicKey.findProgramAddress([Buffer.from('fair_launch'),tokenMint.toBuffer(),buyer.toBuffer()],FAIR_LAUNCH_PROGRAM);case 2:return _context3.abrupt(\"return\",_context3.sent);case 3:case\"end\":return _context3.stop();}}},_callee3);}));return function getFairLaunchTicket(_x6,_x7){return _ref3.apply(this,arguments);};}();export var getFairLaunchLotteryBitmap=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(tokenMint){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return anchor.web3.PublicKey.findProgramAddress([Buffer.from('fair_launch'),tokenMint.toBuffer(),Buffer.from('lottery')],FAIR_LAUNCH_PROGRAM);case 2:return _context4.abrupt(\"return\",_context4.sent);case 3:case\"end\":return _context4.stop();}}},_callee4);}));return function getFairLaunchLotteryBitmap(_x8){return _ref4.apply(this,arguments);};}();var getSetupForTicketing=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(anchorProgram,amount,anchorWallet,fairLaunch,ticketKey){var ticket,remainingAccounts,instructions,signers,amountLamports,transferAuthority,_ticket$data,_yield$getFairLaunchT3,_yield$getFairLaunchT4,fairLaunchTicketSeqLookup,seqBump,seq;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(fairLaunch){_context5.next=2;break;}return _context5.abrupt(\"return\",{remainingAccounts:[],instructions:[],signers:[],amountLamports:0});case 2:ticket=fairLaunch.ticket;remainingAccounts=[];instructions=[];signers=[];amountLamports=0;//@ts-ignore\nif(fairLaunch.state.treasuryMint){_context5.next=11;break;}if(!ticket&&amount===0){amountLamports=fairLaunch.state.data.priceRangeStart.toNumber();}else{amountLamports=Math.ceil(amount*LAMPORTS_PER_SOL);}_context5.next=23;break;case 11:transferAuthority=anchor.web3.Keypair.generate();signers.push(transferAuthority);// NOTE this token impl will not work till you get decimal mantissa and multiply...\n/// ex from cli wont work since you dont have a Signer, but an anchor.Wallet\n/*\n    const token = new Token(\n        anchorProgram.provider.connection,\n        //@ts-ignore\n        fairLaunchObj.treasuryMint,\n        TOKEN_PROGRAM_ID,\n        walletKeyPair,\n      );\n      const mintInfo = await token.getMintInfo();\n      amountNumber = Math.ceil(amountNumber * 10 ** mintInfo.decimals);\n    */instructions.push(Token.createApproveInstruction(TOKEN_PROGRAM_ID,//@ts-ignore\nfairLaunch.state.treasuryMint,transferAuthority.publicKey,anchorWallet.publicKey,[],//@ts-ignore\n// TODO: get mint decimals\namountNumber+fairLaunch.state.data.fees.toNumber()));remainingAccounts.push({//@ts-ignore\npubkey:fairLaunch.state.treasuryMint,isWritable:true,isSigner:false});_context5.t0=remainingAccounts;_context5.next=18;return getAtaForMint(//@ts-ignore\nfairLaunch.state.treasuryMint,anchorWallet.publicKey);case 18:_context5.t1=_context5.sent[0];_context5.t2={pubkey:_context5.t1,isWritable:true,isSigner:false};_context5.t0.push.call(_context5.t0,_context5.t2);remainingAccounts.push({pubkey:transferAuthority.publicKey,isWritable:false,isSigner:true});remainingAccounts.push({pubkey:TOKEN_PROGRAM_ID,isWritable:false,isSigner:false});case 23:if(!ticket.data){_context5.next=39;break;}_context5.next=26;return getFairLaunchTicketSeqLookup(fairLaunch.state.tokenMint,(_ticket$data=ticket.data)===null||_ticket$data===void 0?void 0:_ticket$data.seq);case 26:_yield$getFairLaunchT3=_context5.sent;_yield$getFairLaunchT4=_slicedToArray(_yield$getFairLaunchT3,2);fairLaunchTicketSeqLookup=_yield$getFairLaunchT4[0];seqBump=_yield$getFairLaunchT4[1];_context5.next=32;return anchorProgram.provider.connection.getAccountInfo(fairLaunchTicketSeqLookup);case 32:seq=_context5.sent;if(seq){_context5.next=39;break;}_context5.t3=instructions;_context5.next=37;return anchorProgram.instruction.createTicketSeq(seqBump,{accounts:{fairLaunchTicketSeqLookup:fairLaunchTicketSeqLookup,fairLaunch:fairLaunch.id,fairLaunchTicket:ticketKey,payer:anchorWallet.publicKey,systemProgram:anchor.web3.SystemProgram.programId,rent:anchor.web3.SYSVAR_RENT_PUBKEY},signers:[]});case 37:_context5.t4=_context5.sent;_context5.t3.push.call(_context5.t3,_context5.t4);case 39:return _context5.abrupt(\"return\",{remainingAccounts:remainingAccounts,instructions:instructions,signers:signers,amountLamports:amountLamports});case 40:case\"end\":return _context5.stop();}}},_callee5);}));return function getSetupForTicketing(_x9,_x10,_x11,_x12,_x13){return _ref5.apply(this,arguments);};}();export var receiveRefund=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(anchorWallet,fairLaunch){var buyerTokenAccount,transferAuthority,signers,instructions,remainingAccounts;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:if(fairLaunch){_context6.next=2;break;}return _context6.abrupt(\"return\");case 2:_context6.next=4;return getAtaForMint(fairLaunch.state.tokenMint,anchorWallet.publicKey);case 4:buyerTokenAccount=_context6.sent[0];transferAuthority=anchor.web3.Keypair.generate();signers=[transferAuthority];instructions=[Token.createApproveInstruction(TOKEN_PROGRAM_ID,buyerTokenAccount,transferAuthority.publicKey,anchorWallet.publicKey,[],1)];remainingAccounts=[];if(!fairLaunch.state.treasuryMint){_context6.next=17;break;}remainingAccounts.push({pubkey:fairLaunch.state.treasuryMint,isWritable:true,isSigner:false});_context6.t0=remainingAccounts;_context6.next=14;return getAtaForMint(fairLaunch.state.treasuryMint,anchorWallet.publicKey);case 14:_context6.t1=_context6.sent[0];_context6.t2={pubkey:_context6.t1,isWritable:true,isSigner:false};_context6.t0.push.call(_context6.t0,_context6.t2);case 17:console.log('tfr',fairLaunch.state.treasury.toBase58(),anchorWallet.publicKey.toBase58(),buyerTokenAccount.toBase58());_context6.next=20;return fairLaunch.program.rpc.receiveRefund({accounts:{fairLaunch:fairLaunch.id,treasury:fairLaunch.state.treasury,buyer:anchorWallet.publicKey,buyerTokenAccount:buyerTokenAccount,transferAuthority:transferAuthority.publicKey,tokenMint:fairLaunch.state.tokenMint,tokenProgram:TOKEN_PROGRAM_ID,systemProgram:anchor.web3.SystemProgram.programId,clock:anchor.web3.SYSVAR_CLOCK_PUBKEY},__private:{logAccounts:true},remainingAccounts:remainingAccounts,instructions:instructions,signers:signers});case 20:case\"end\":return _context6.stop();}}},_callee6);}));return function receiveRefund(_x14,_x15){return _ref6.apply(this,arguments);};}();export var purchaseTicket=/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(amount,anchorWallet,fairLaunch){var ticket,_yield$getFairLaunchT5,_yield$getFairLaunchT6,fairLaunchTicket,bump,_yield$getSetupForTic2,remainingAccounts,instructions,signers,amountLamports,fairLaunchLotteryBitmap;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:if(fairLaunch){_context7.next=2;break;}return _context7.abrupt(\"return\");case 2:ticket=fairLaunch.ticket.data;_context7.next=5;return getFairLaunchTicket(//@ts-ignore\nfairLaunch.state.tokenMint,anchorWallet.publicKey);case 5:_yield$getFairLaunchT5=_context7.sent;_yield$getFairLaunchT6=_slicedToArray(_yield$getFairLaunchT5,2);fairLaunchTicket=_yield$getFairLaunchT6[0];bump=_yield$getFairLaunchT6[1];_context7.next=11;return getSetupForTicketing(fairLaunch.program,amount,anchorWallet,fairLaunch,fairLaunchTicket);case 11:_yield$getSetupForTic2=_context7.sent;remainingAccounts=_yield$getSetupForTic2.remainingAccounts;instructions=_yield$getSetupForTic2.instructions;signers=_yield$getSetupForTic2.signers;amountLamports=_yield$getSetupForTic2.amountLamports;if(!ticket){_context7.next=24;break;}_context7.next=19;return getFairLaunchLotteryBitmap(fairLaunch.state.tokenMint);case 19:fairLaunchLotteryBitmap=_context7.sent[0];console.log('Anchor wallet',anchorWallet.publicKey.toBase58(),amountLamports);_context7.next=23;return fairLaunch.program.rpc.adjustTicket(new anchor.BN(amountLamports),{accounts:{fairLaunchTicket:fairLaunchTicket,fairLaunch:fairLaunch.id,fairLaunchLotteryBitmap:fairLaunchLotteryBitmap,//@ts-ignore\ntreasury:fairLaunch.state.treasury,systemProgram:anchor.web3.SystemProgram.programId,clock:anchor.web3.SYSVAR_CLOCK_PUBKEY},__private:{logAccounts:true},remainingAccounts:[{pubkey:anchorWallet.publicKey,isSigner:true,isWritable:true}].concat(_toConsumableArray(remainingAccounts)),signers:signers,instructions:instructions.length>0?instructions:undefined});case 23:return _context7.abrupt(\"return\");case 24:_context7.prev=24;console.log('Amount',amountLamports);_context7.next=28;return fairLaunch.program.rpc.purchaseTicket(bump,new anchor.BN(amountLamports),{accounts:{fairLaunchTicket:fairLaunchTicket,fairLaunch:fairLaunch.id,//@ts-ignore\ntreasury:fairLaunch.state.treasury,buyer:anchorWallet.publicKey,payer:anchorWallet.publicKey,systemProgram:anchor.web3.SystemProgram.programId,rent:anchor.web3.SYSVAR_RENT_PUBKEY,clock:anchor.web3.SYSVAR_CLOCK_PUBKEY},//__private: { logAccounts: true },\nremainingAccounts:remainingAccounts,signers:signers,instructions:instructions.length>0?instructions:undefined});case 28:_context7.next=34;break;case 30:_context7.prev=30;_context7.t0=_context7[\"catch\"](24);console.log(_context7.t0);throw _context7.t0;case 34:case\"end\":return _context7.stop();}}},_callee7,null,[[24,30]]);}));return function purchaseTicket(_x16,_x17,_x18){return _ref7.apply(this,arguments);};}();export var withdrawFunds=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(anchorWallet,fairLaunch){var remainingAccounts;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:if(fairLaunch){_context8.next=2;break;}return _context8.abrupt(\"return\");case 2:// TODO: create sequence ticket\nremainingAccounts=[];//@ts-ignore\nif(!fairLaunch.state.treasuryMint){_context8.next=12;break;}remainingAccounts.push({//@ts-ignore\npubkey:fairLaunch.state.treasuryMint,isWritable:true,isSigner:false});_context8.t0=remainingAccounts;_context8.next=8;return getAtaForMint(//@ts-ignore\nfairLaunch.state.treasuryMint,anchorWallet.publicKey);case 8:_context8.t1=_context8.sent[0];_context8.t2={pubkey:_context8.t1,isWritable:true,isSigner:false};_context8.t0.push.call(_context8.t0,_context8.t2);remainingAccounts.push({pubkey:TOKEN_PROGRAM_ID,isWritable:false,isSigner:false});case 12:_context8.next=14;return fairLaunch.program.rpc.withdrawFunds({accounts:{fairLaunch:fairLaunch.id,// @ts-ignore\ntreasury:fairLaunch.state.treasury,authority:anchorWallet.publicKey,// @ts-ignore\ntokenMint:fairLaunch.state.tokenMint,systemProgram:anchor.web3.SystemProgram.programId},remainingAccounts:remainingAccounts});case 14:case\"end\":return _context8.stop();}}},_callee8);}));return function withdrawFunds(_x19,_x20){return _ref8.apply(this,arguments);};}();","map":{"version":3,"sources":["/Users/timgillam/Documents/GitHub/metaplex_new/new-metaplex/js/packages/fair-launch/src/fair-launch.ts"],"names":["anchor","TOKEN_PROGRAM_ID","Token","LAMPORTS_PER_SOL","createAssociatedTokenAccountInstruction","getAtaForMint","getFairLaunchTicketSeqLookup","FAIR_LAUNCH_PROGRAM","web3","PublicKey","LotteryState","getLotteryState","phaseThree","lottery","lotteryDuration","phaseTwoEnd","length","add","lt","BN","Date","now","PastDue","Finished","Brewing","getFairLaunchState","anchorWallet","fairLaunchId","connection","provider","Provider","preflightCommitment","Program","fetchIdl","idl","program","account","fairLaunch","fetch","state","getFairLaunchTicket","tokenMint","publicKey","fairLaunchTicket","bump","fairLaunchData","console","log","getBalance","treasury","lotteryData","Uint8Array","getFairLaunchLotteryBitmap","fairLaunchLotteryBitmap","getAccountInfo","fairLaunchLotteryBitmapObj","data","id","ticket","pubkey","punchTicket","buyerTokenAccount","amount","gt","currentMedian","toNumber","getSetupForTicketing","remainingAccounts","instructions","signers","rpc","adjustTicket","accounts","systemProgram","SystemProgram","programId","clock","SYSVAR_CLOCK_PUBKEY","__private","logAccounts","undefined","isSigner","isWritable","accountExists","payer","tokenProgram","buyer","findProgramAddress","Buffer","from","toBuffer","anchorProgram","ticketKey","amountLamports","treasuryMint","priceRangeStart","Math","ceil","transferAuthority","Keypair","generate","push","createApproveInstruction","amountNumber","fees","seq","fairLaunchTicketSeqLookup","seqBump","instruction","createTicketSeq","rent","SYSVAR_RENT_PUBKEY","receiveRefund","toBase58","purchaseTicket","withdrawFunds","authority"],"mappings":"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","sourcesContent":["import * as anchor from '@project-serum/anchor';\n\nimport { TOKEN_PROGRAM_ID, Token } from '@solana/spl-token';\nimport { LAMPORTS_PER_SOL, TransactionInstruction } from '@solana/web3.js';\nimport {\n  createAssociatedTokenAccountInstruction,\n  getAtaForMint,\n  getFairLaunchTicketSeqLookup,\n} from './utils';\n\nexport const FAIR_LAUNCH_PROGRAM = new anchor.web3.PublicKey(\n  'faircnAB9k59Y4TXmLabBULeuTLgV7TkGMGNkjnA15j',\n);\n\nexport interface FairLaunchAccount {\n  id: anchor.web3.PublicKey;\n  program: anchor.Program;\n  state: FairLaunchState;\n\n  ticket: {\n    pubkey: anchor.web3.PublicKey;\n    bump: number;\n    data?: FairLaunchTicket;\n  };\n  lottery: {\n    pubkey: anchor.web3.PublicKey;\n    data?: Uint8Array;\n  };\n  treasury: number;\n}\n\nexport interface FairLaunchTicket {\n  fairLaunch: anchor.web3.PublicKey;\n  buyer: anchor.web3.PublicKey;\n  amount: anchor.BN;\n  state: {\n    punched?: {};\n    unpunched?: {};\n    withdrawn?: {};\n    no_sequence_struct: {};\n  };\n  bump: number;\n  seq: anchor.BN;\n}\n\nexport interface AntiRugSetting {\n  reserveBp: number;\n  tokenRequirement: anchor.BN;\n  selfDestructDate: anchor.BN;\n}\nexport interface FairLaunchState {\n  authority: anchor.web3.PublicKey;\n  bump: number;\n\n  currentMedian: anchor.BN;\n  currentEligibleHolders: anchor.BN;\n  data: {\n    antiRugSetting?: AntiRugSetting;\n    fee: anchor.BN;\n    numberOfTokens: anchor.BN;\n    phaseOneEnd: anchor.BN;\n    phaseOneStart: anchor.BN;\n    phaseTwoEnd: anchor.BN;\n    priceRangeEnd: anchor.BN;\n    priceRangeStart: anchor.BN;\n    lotteryDuration: anchor.BN;\n    tickSize: anchor.BN;\n    uuid: string;\n  };\n  numberTicketsDropped: anchor.BN;\n  numberTicketsPunched: anchor.BN;\n  numberTicketsSold: anchor.BN;\n  numberTicketsUnSeqed: anchor.BN;\n  numberTokensBurnedForRefunds: anchor.BN;\n  numberTokensPreminted: anchor.BN;\n  phaseThreeStarted: boolean;\n  tokenMint: anchor.web3.PublicKey;\n  tokenMintBump: number;\n  treasury: anchor.web3.PublicKey;\n  treasuryBump: number;\n  treasuryMint: anchor.web3.PublicKey; // only for SPL tokens\n  treasurySnapshot: null;\n}\n\nexport enum LotteryState {\n  Brewing = 'Brewing',\n  Finished = 'Finished',\n  PastDue = 'Past Due',\n}\n\nexport const getLotteryState = (\n  phaseThree: boolean | undefined,\n  lottery: Uint8Array | null,\n  lotteryDuration: anchor.BN,\n  phaseTwoEnd: anchor.BN,\n): LotteryState => {\n  if (\n    !phaseThree &&\n    (!lottery || lottery.length === 0) &&\n    phaseTwoEnd.add(lotteryDuration).lt(new anchor.BN(Date.now() / 1000))\n  ) {\n    return LotteryState.PastDue;\n  } else if (phaseThree) {\n    return LotteryState.Finished;\n  } else {\n    return LotteryState.Brewing;\n  }\n};\n\nexport const getFairLaunchState = async (\n  anchorWallet: anchor.Wallet,\n  fairLaunchId: anchor.web3.PublicKey,\n  connection: anchor.web3.Connection,\n): Promise<FairLaunchAccount> => {\n  const provider = new anchor.Provider(connection, anchorWallet, {\n    preflightCommitment: 'recent',\n  });\n\n  const idl = await anchor.Program.fetchIdl(FAIR_LAUNCH_PROGRAM, provider);\n\n  const program = new anchor.Program(idl, FAIR_LAUNCH_PROGRAM, provider);\n  const state: any = await program.account.fairLaunch.fetch(fairLaunchId);\n\n  const [fairLaunchTicket, bump] = await getFairLaunchTicket(\n    //@ts-ignore\n    state.tokenMint,\n    anchorWallet.publicKey,\n  );\n\n  let fairLaunchData: any;\n\n  try {\n    fairLaunchData = await program.account.fairLaunchTicket.fetch(\n      fairLaunchTicket,\n    );\n  } catch {\n    console.log('No ticket');\n  }\n\n  const treasury = await program.provider.connection.getBalance(state.treasury);\n\n  let lotteryData: Uint8Array = new Uint8Array([]);\n  let fairLaunchLotteryBitmap = (\n    await getFairLaunchLotteryBitmap(\n      //@ts-ignore\n      state.tokenMint,\n    )\n  )[0];\n\n  try {\n    const fairLaunchLotteryBitmapObj =\n      await program.provider.connection.getAccountInfo(fairLaunchLotteryBitmap);\n\n    lotteryData = new Uint8Array(fairLaunchLotteryBitmapObj?.data || []);\n  } catch (e) {\n    console.log('Could not find fair launch lottery.');\n    console.log(e);\n  }\n\n  return {\n    id: fairLaunchId,\n    state,\n    program,\n    ticket: {\n      pubkey: fairLaunchTicket,\n      bump,\n      data: fairLaunchData,\n    },\n    lottery: {\n      pubkey: fairLaunchLotteryBitmap,\n      data: lotteryData,\n    },\n    treasury,\n  };\n};\n\nexport const punchTicket = async (\n  anchorWallet: anchor.Wallet,\n  fairLaunch: FairLaunchAccount,\n) => {\n  const fairLaunchTicket = (\n    await getFairLaunchTicket(\n      //@ts-ignore\n      fairLaunch.state.tokenMint,\n      anchorWallet.publicKey,\n    )\n  )[0];\n\n  const ticket = fairLaunch.ticket.data;\n\n  const fairLaunchLotteryBitmap = //@ts-ignore\n  (await getFairLaunchLotteryBitmap(fairLaunch.state.tokenMint))[0];\n\n  const buyerTokenAccount = (\n    await getAtaForMint(\n      //@ts-ignore\n      fairLaunch.state.tokenMint,\n      anchorWallet.publicKey,\n    )\n  )[0];\n\n  if (ticket?.amount.gt(fairLaunch.state.currentMedian)) {\n    console.log(\n      'Adjusting down...',\n      ticket?.amount.toNumber(),\n      fairLaunch.state.currentMedian.toNumber(),\n    );\n    const { remainingAccounts, instructions, signers } =\n      await getSetupForTicketing(\n        fairLaunch.program,\n        fairLaunch.state.currentMedian.toNumber(),\n        anchorWallet,\n        fairLaunch,\n        fairLaunchTicket,\n      );\n    await fairLaunch.program.rpc.adjustTicket(fairLaunch.state.currentMedian, {\n      accounts: {\n        fairLaunchTicket,\n        fairLaunch: fairLaunch.id,\n        fairLaunchLotteryBitmap,\n        //@ts-ignore\n        treasury: fairLaunch.state.treasury,\n        systemProgram: anchor.web3.SystemProgram.programId,\n        clock: anchor.web3.SYSVAR_CLOCK_PUBKEY,\n      },\n      __private: { logAccounts: true },\n      instructions: instructions.length > 0 ? instructions : undefined,\n      remainingAccounts: [\n        {\n          pubkey: anchorWallet.publicKey,\n          isSigner: true,\n          isWritable: true,\n        },\n        ...remainingAccounts,\n      ],\n      signers,\n    });\n  }\n\n  const accountExists =\n    await fairLaunch.program.provider.connection.getAccountInfo(\n      buyerTokenAccount,\n    );\n\n  const instructions = !accountExists\n    ? [\n        createAssociatedTokenAccountInstruction(\n          buyerTokenAccount,\n          anchorWallet.publicKey,\n          anchorWallet.publicKey,\n          //@ts-ignore\n          fairLaunch.state.tokenMint,\n        ),\n      ]\n    : [];\n\n  await fairLaunch.program.rpc.punchTicket({\n    accounts: {\n      fairLaunchTicket,\n      fairLaunch: fairLaunch.id,\n      fairLaunchLotteryBitmap,\n      payer: anchorWallet.publicKey,\n      buyerTokenAccount,\n      //@ts-ignore\n      tokenMint: fairLaunch.state.tokenMint,\n      tokenProgram: TOKEN_PROGRAM_ID,\n    },\n    instructions: instructions.length > 0 ? instructions : undefined,\n  });\n};\n\nexport const getFairLaunchTicket = async (\n  tokenMint: anchor.web3.PublicKey,\n  buyer: anchor.web3.PublicKey,\n): Promise<[anchor.web3.PublicKey, number]> => {\n  return await anchor.web3.PublicKey.findProgramAddress(\n    [Buffer.from('fair_launch'), tokenMint.toBuffer(), buyer.toBuffer()],\n    FAIR_LAUNCH_PROGRAM,\n  );\n};\n\nexport const getFairLaunchLotteryBitmap = async (\n  tokenMint: anchor.web3.PublicKey,\n): Promise<[anchor.web3.PublicKey, number]> => {\n  return await anchor.web3.PublicKey.findProgramAddress(\n    [Buffer.from('fair_launch'), tokenMint.toBuffer(), Buffer.from('lottery')],\n    FAIR_LAUNCH_PROGRAM,\n  );\n};\n\nconst getSetupForTicketing = async (\n  anchorProgram: anchor.Program,\n  amount: number,\n  anchorWallet: anchor.Wallet,\n  fairLaunch: FairLaunchAccount | undefined,\n  ticketKey: anchor.web3.PublicKey,\n): Promise<{\n  remainingAccounts: {\n    pubkey: anchor.web3.PublicKey | null;\n    isWritable: boolean;\n    isSigner: boolean;\n  }[];\n  instructions: TransactionInstruction[];\n  signers: anchor.web3.Keypair[];\n  amountLamports: number;\n}> => {\n  if (!fairLaunch) {\n    return {\n      remainingAccounts: [],\n      instructions: [],\n      signers: [],\n      amountLamports: 0,\n    };\n  }\n  const ticket = fairLaunch.ticket;\n\n  const remainingAccounts = [];\n  const instructions = [];\n  const signers = [];\n\n  let amountLamports = 0;\n  //@ts-ignore\n  if (!fairLaunch.state.treasuryMint) {\n    if (!ticket && amount === 0) {\n      amountLamports = fairLaunch.state.data.priceRangeStart.toNumber();\n    } else {\n      amountLamports = Math.ceil(amount * LAMPORTS_PER_SOL);\n    }\n  } else {\n    const transferAuthority = anchor.web3.Keypair.generate();\n    signers.push(transferAuthority);\n    // NOTE this token impl will not work till you get decimal mantissa and multiply...\n    /// ex from cli wont work since you dont have a Signer, but an anchor.Wallet\n    /*\n    const token = new Token(\n        anchorProgram.provider.connection,\n        //@ts-ignore\n        fairLaunchObj.treasuryMint,\n        TOKEN_PROGRAM_ID,\n        walletKeyPair,\n      );\n      const mintInfo = await token.getMintInfo();\n      amountNumber = Math.ceil(amountNumber * 10 ** mintInfo.decimals);\n    */\n    instructions.push(\n      Token.createApproveInstruction(\n        TOKEN_PROGRAM_ID,\n        //@ts-ignore\n        fairLaunch.state.treasuryMint,\n        transferAuthority.publicKey,\n        anchorWallet.publicKey,\n        [],\n        //@ts-ignore\n\n        // TODO: get mint decimals\n        amountNumber + fairLaunch.state.data.fees.toNumber(),\n      ),\n    );\n\n    remainingAccounts.push({\n      //@ts-ignore\n      pubkey: fairLaunch.state.treasuryMint,\n      isWritable: true,\n      isSigner: false,\n    });\n    remainingAccounts.push({\n      pubkey: (\n        await getAtaForMint(\n          //@ts-ignore\n          fairLaunch.state.treasuryMint,\n          anchorWallet.publicKey,\n        )\n      )[0],\n      isWritable: true,\n      isSigner: false,\n    });\n    remainingAccounts.push({\n      pubkey: transferAuthority.publicKey,\n      isWritable: false,\n      isSigner: true,\n    });\n    remainingAccounts.push({\n      pubkey: TOKEN_PROGRAM_ID,\n      isWritable: false,\n      isSigner: false,\n    });\n  }\n\n  if (ticket.data) {\n    const [fairLaunchTicketSeqLookup, seqBump] =\n      await getFairLaunchTicketSeqLookup(\n        fairLaunch.state.tokenMint,\n        ticket.data?.seq,\n      );\n\n    const seq = await anchorProgram.provider.connection.getAccountInfo(\n      fairLaunchTicketSeqLookup,\n    );\n    if (!seq) {\n      instructions.push(\n        await anchorProgram.instruction.createTicketSeq(seqBump, {\n          accounts: {\n            fairLaunchTicketSeqLookup,\n            fairLaunch: fairLaunch.id,\n            fairLaunchTicket: ticketKey,\n            payer: anchorWallet.publicKey,\n            systemProgram: anchor.web3.SystemProgram.programId,\n            rent: anchor.web3.SYSVAR_RENT_PUBKEY,\n          },\n          signers: [],\n        }),\n      );\n    }\n  }\n\n  return {\n    remainingAccounts,\n    instructions,\n    signers,\n    amountLamports,\n  };\n};\n\nexport const receiveRefund = async (\n  anchorWallet: anchor.Wallet,\n  fairLaunch: FairLaunchAccount | undefined,\n) => {\n  if (!fairLaunch) {\n    return;\n  }\n\n  const buyerTokenAccount = (\n    await getAtaForMint(fairLaunch.state.tokenMint, anchorWallet.publicKey)\n  )[0];\n\n  const transferAuthority = anchor.web3.Keypair.generate();\n\n  const signers = [transferAuthority];\n  const instructions = [\n    Token.createApproveInstruction(\n      TOKEN_PROGRAM_ID,\n      buyerTokenAccount,\n      transferAuthority.publicKey,\n      anchorWallet.publicKey,\n      [],\n      1,\n    ),\n  ];\n\n  const remainingAccounts = [];\n\n  if (fairLaunch.state.treasuryMint) {\n    remainingAccounts.push({\n      pubkey: fairLaunch.state.treasuryMint,\n      isWritable: true,\n      isSigner: false,\n    });\n    remainingAccounts.push({\n      pubkey: (\n        await getAtaForMint(\n          fairLaunch.state.treasuryMint,\n          anchorWallet.publicKey,\n        )\n      )[0],\n      isWritable: true,\n      isSigner: false,\n    });\n  }\n\n  console.log(\n    'tfr',\n    fairLaunch.state.treasury.toBase58(),\n    anchorWallet.publicKey.toBase58(),\n    buyerTokenAccount.toBase58(),\n  );\n  await fairLaunch.program.rpc.receiveRefund({\n    accounts: {\n      fairLaunch: fairLaunch.id,\n      treasury: fairLaunch.state.treasury,\n      buyer: anchorWallet.publicKey,\n      buyerTokenAccount,\n      transferAuthority: transferAuthority.publicKey,\n      tokenMint: fairLaunch.state.tokenMint,\n      tokenProgram: TOKEN_PROGRAM_ID,\n      systemProgram: anchor.web3.SystemProgram.programId,\n      clock: anchor.web3.SYSVAR_CLOCK_PUBKEY,\n    },\n\n    __private: { logAccounts: true },\n    remainingAccounts,\n    instructions,\n    signers,\n  });\n};\nexport const purchaseTicket = async (\n  amount: number,\n  anchorWallet: anchor.Wallet,\n  fairLaunch: FairLaunchAccount | undefined,\n) => {\n  if (!fairLaunch) {\n    return;\n  }\n\n  const ticket = fairLaunch.ticket.data;\n\n  const [fairLaunchTicket, bump] = await getFairLaunchTicket(\n    //@ts-ignore\n    fairLaunch.state.tokenMint,\n    anchorWallet.publicKey,\n  );\n\n  const { remainingAccounts, instructions, signers, amountLamports } =\n    await getSetupForTicketing(\n      fairLaunch.program,\n      amount,\n      anchorWallet,\n      fairLaunch,\n      fairLaunchTicket,\n    );\n\n  if (ticket) {\n    const fairLaunchLotteryBitmap = ( //@ts-ignore\n      await getFairLaunchLotteryBitmap(fairLaunch.state.tokenMint)\n    )[0];\n    console.log(\n      'Anchor wallet',\n      anchorWallet.publicKey.toBase58(),\n      amountLamports,\n    );\n    await fairLaunch.program.rpc.adjustTicket(new anchor.BN(amountLamports), {\n      accounts: {\n        fairLaunchTicket,\n        fairLaunch: fairLaunch.id,\n        fairLaunchLotteryBitmap,\n        //@ts-ignore\n        treasury: fairLaunch.state.treasury,\n        systemProgram: anchor.web3.SystemProgram.programId,\n        clock: anchor.web3.SYSVAR_CLOCK_PUBKEY,\n      },\n      __private: { logAccounts: true },\n      remainingAccounts: [\n        {\n          pubkey: anchorWallet.publicKey,\n          isSigner: true,\n          isWritable: true,\n        },\n        ...remainingAccounts,\n      ],\n      signers,\n      instructions: instructions.length > 0 ? instructions : undefined,\n    });\n\n    return;\n  }\n  try {\n    console.log('Amount', amountLamports);\n    await fairLaunch.program.rpc.purchaseTicket(\n      bump,\n      new anchor.BN(amountLamports),\n      {\n        accounts: {\n          fairLaunchTicket,\n          fairLaunch: fairLaunch.id,\n          //@ts-ignore\n          treasury: fairLaunch.state.treasury,\n          buyer: anchorWallet.publicKey,\n          payer: anchorWallet.publicKey,\n          systemProgram: anchor.web3.SystemProgram.programId,\n          rent: anchor.web3.SYSVAR_RENT_PUBKEY,\n          clock: anchor.web3.SYSVAR_CLOCK_PUBKEY,\n        },\n        //__private: { logAccounts: true },\n        remainingAccounts,\n        signers,\n        instructions: instructions.length > 0 ? instructions : undefined,\n      },\n    );\n  } catch (e) {\n    console.log(e);\n    throw e;\n  }\n};\n\nexport const withdrawFunds = async (\n  anchorWallet: anchor.Wallet,\n  fairLaunch: FairLaunchAccount | undefined,\n) => {\n  if (!fairLaunch) {\n    return;\n  }\n\n  // TODO: create sequence ticket\n\n  const remainingAccounts = [];\n\n  //@ts-ignore\n  if (fairLaunch.state.treasuryMint) {\n    remainingAccounts.push({\n      //@ts-ignore\n      pubkey: fairLaunch.state.treasuryMint,\n      isWritable: true,\n      isSigner: false,\n    });\n    remainingAccounts.push({\n      pubkey: (\n        await getAtaForMint(\n          //@ts-ignore\n          fairLaunch.state.treasuryMint,\n          anchorWallet.publicKey,\n        )\n      )[0],\n      isWritable: true,\n      isSigner: false,\n    });\n    remainingAccounts.push({\n      pubkey: TOKEN_PROGRAM_ID,\n      isWritable: false,\n      isSigner: false,\n    });\n  }\n\n  await fairLaunch.program.rpc.withdrawFunds({\n    accounts: {\n      fairLaunch: fairLaunch.id,\n      // @ts-ignore\n      treasury: fairLaunch.state.treasury,\n      authority: anchorWallet.publicKey,\n      // @ts-ignore\n      tokenMint: fairLaunch.state.tokenMint,\n      systemProgram: anchor.web3.SystemProgram.programId,\n    },\n    remainingAccounts,\n  });\n};\n"]},"metadata":{},"sourceType":"module"}